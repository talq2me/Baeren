<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Picture Sentence Game</title>
    
    <link rel="stylesheet" href="../styles.css">
    <style>
        body {
            font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif;
            background: #f6f8fa;
            margin: 0;
            padding: 0;
        }
        .game-container {
            max-width: 600px;
            margin: 40px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            padding: 32px 24px;
            text-align: center;
        }
        .sentence-text {
            font-size: 2em;
            margin-bottom: 24px;
        }
        .sentence-text span {
            transition: background 0.2s;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .tts-highlight {
            background: #ffe066;
        }
        .picture-buttons {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 24px;
        }
        .picture-btn {
            border: 2px solid #eee;
            border-radius: 12px;
            background: #fafafa;
            cursor: pointer;
            transition: border 0.2s, box-shadow 0.2s;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            position: relative;
        }
        .picture-btn.selected {
            border: 2px solid #51cf66;
            box-shadow: 0 0 0 4px #b2f2bb;
        }
        .picture-btn img {
            max-width: 80px;
            max-height: 80px;
        }
        .feedback {
            font-size: 1.3em;
            margin-bottom: 16px;
            min-height: 1.3em;
        }
        
        .star-count {
            font-size: 1.2em;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="star-count" id="starCount">‚≠ê 0 / 5</div>
        <div class="sentence-text" id="sentenceText"></div>
        <button class="button" id="playBtn">&#9654; Play Again</button>
        <div class="picture-buttons" id="pictureButtons"></div>
        <div class="feedback" id="feedback"></div>
    </div>
    <script>
        // Game data: Add your rounds here!
        const rounds = [
            {
                sentence: "Puis-je aller aux toilettes ?",
                correct: "toilet",
                pictures: [
                    { id: "toilet", img: "../images/toilet.png", alt: "" },
                    { id: "playground", img: "../images/playground.png", alt: "" }
                ]
            },
            {
                sentence: "Puis-je laver les mains ?",
                correct: "sink",
                pictures: [
                    { id: "sink", img: "../images/washHands.png", alt: "" },
                    { id: "collation", img: "../images/collation.png", alt: "" }
                ]
            },
            {
                sentence: "Puis-je tailler mon crayon ?",
                correct: "sharpen",
                pictures: [
                    { id: "sharpen", img: "../images/sharpen.png", alt: "" },
                    { id: "penny", img: "../images/penny.png", alt: "" }
                ]
            },
            {
                sentence: "Puis-je aller chercher ma bouteille d‚Äôeau ?",
                correct: "water",
                pictures: [
                    { id: "water", img: "../images/WaterBottle.png", alt: "" },
                    { id: "eraser", img: "../images/eraser.png", alt: "" }
                ]
            },
            {
                sentence: "Puis-je aller √† mon casier ?",
                correct: "locker",
                pictures: [
                    { id: "locker", img: "../images/locker.png", alt: "" },
                    { id: "toilet", img: "../images/toilet.png", alt: "" }
                ]
            },
            {
                sentence: "Puis-je avoir une gomme ?",
                correct: "eraser",
                pictures: [
                    { id: "eraser", img: "../images/eraser.png", alt: "" },
                    { id: "sharpen", img: "../images/sharpen.png", alt: "" }
                ]
            },
            {
                sentence: "Puis-je avoir un crayon ?",
                correct: "pencil",
                pictures: [
                    { id: "pencil", img: "../images/pencil.png", alt: "" },
                    { id: "paper", img: "../images/paper.png", alt: "" }
                ]
            },
            {
                sentence: "Puis-je avoir une feuille de papier ?",
                correct: "paper",
                pictures: [
                    { id: "paper", img: "../images/paper.png", alt: "" },
                    { id: "penny", img: "../images/penny.png", alt: "" }
                ]
            },
            
            
            {
                sentence: "Est-ce que je peux aller aux toilettes ?",
                correct: "toilet",
                pictures: [
                    { id: "toilet", img: "../images/toilet.png", alt: "" },
                    { id: "playground", img: "../images/playground.png", alt: "" }
                ]
            },
            {
                sentence: "Est-ce que je peux laver les mains ?",
                correct: "sink",
                pictures: [
                    { id: "sink", img: "../images/washHands.png", alt: "" },
                    { id: "collation", img: "../images/collation.png", alt: "" }
                ]
            },
            {
                sentence: "Est-ce que je peux aiguiser mon crayon ?",
                correct: "sharpen",
                pictures: [
                    { id: "sharpen", img: "../images/sharpen.png", alt: "" },
                    { id: "penny", img: "../images/penny.png", alt: "" }
                ]
            },
            {
                sentence: "Est-ce que je peux aller chercher ma bouteille d‚Äôeau ?",
                correct: "water",
                pictures: [
                    { id: "water", img: "../images/WaterBottle.png", alt: "" },
                    { id: "eraser", img: "../images/eraser.png", alt: "" }
                ]
            },
            {
                sentence: "Est-ce que je peux aller √† mon casier ?",
                correct: "locker",
                pictures: [
                    { id: "locker", img: "../images/locker.png", alt: "" },
                    { id: "toilet", img: "../images/toilet.png", alt: "" }
                ]
            },
            {
                sentence: "Est-ce que je peux avoir une gomme ?",
                correct: "eraser",
                pictures: [
                    { id: "eraser", img: "../images/eraser.png", alt: "" },
                    { id: "sharpen", img: "../images/sharpen.png", alt: "" }
                ]
            },
            {
                sentence: "Est-ce que je peux avoir un crayon ?",
                correct: "pencil",
                pictures: [
                    { id: "pencil", img: "../images/pencil.png", alt: "" },
                    { id: "paper", img: "../images/paper.png", alt: "" }
                ]
            },
            {
                sentence: "Est-ce que je peux avoir une feuille de papier ?",
                correct: "paper",
                pictures: [
                    { id: "paper", img: "../images/paper.png", alt: "" },
                    { id: "penny", img: "../images/penny.png", alt: "" }
                ]
            },
            {
                sentence: "C‚Äôest la collation .",
                correct: "collation",
                pictures: [
                    { id: "collation", img: "../images/collation.png", alt: "" },
                    { id: "toilet", img: "../images/toilet.png", alt: "" }
                ]
            }

            ,
            {
                sentence: "J‚Äôai fini !",
                correct: "fini",
                pictures: [
                    { id: "fini", img: "../images/fini.png", alt: "" },
                    { id: "please", img: "../images/please.png", alt: "" }
                ]
            },
            {
                sentence: "De l‚Äôaide, s‚Äôil vous pla√Æt .",
                correct: "help",
                pictures: [
                    { id: "help", img: "../images/help.png", alt: "" },
                    { id: "WaterBottle", img: "../images/WaterBottle.png", alt: "" }
                ]
            },
            {
                sentence: "C‚Äôest le d√Æner .",
                correct: "diner",
                pictures: [
                    { id: "collation", img: "../images/collation.png", alt: "" },
                    { id: "diner", img: "../images/diner.png", alt: "" }
                ]
            },
            {
                sentence: "C‚Äôest la r√©cr√©ation .",
                correct: "playground",
                pictures: [
                    { id: "collation", img: "../images/collation.png", alt: "" },
                    { id: "playground", img: "../images/playground.png", alt: "" }
                ]
            },
            {
                sentence: "J‚Äôai une question .",
                correct: "question",
                pictures: [
                    { id: "question", img: "../images/question.png", alt: "" },
                    { id: "help", img: "../images/help.png", alt: "" }
                ]
            },
            {
                sentence: "Je ne comprends pas .",
                correct: "dontknow",
                pictures: [
                    { id: "dontknow", img: "../images/dontknow.png", alt: "" },
                    { id: "question", img: "../images/question.png", alt: "" }
                ]
            },
            {
                sentence: "Puis-je aller √† mon casier .",
                correct: "locker",
                pictures: [
                    { id: "locker", img: "../images/locker.png", alt: "" },
                    { id: "toilet", img: "../images/toilet.png", alt: "" }
                ]
            },
            {
                sentence: "Est-ce que je peux aller √† mon casier .",
                correct: "locker",
                pictures: [
                    { id: "locker", img: "../images/locker.png", alt: "" },
                    { id: "toilet", img: "../images/toilet.png", alt: "" }
                ]
            }

            ,
            {
                sentence: "Nous allons √† la biblioth√®que .",
                correct: "library",
                pictures: [
                    { id: "locker", img: "../images/locker.png", alt: "" },
                    { id: "library", img: "../images/library.png", alt: "" }
                ]
            },
            {
                sentence: "Nous allons au gymnase .",
                correct: "gym",
                pictures: [
                    { id: "gym", img: "../images/gym.png", alt: "" },
                    { id: "library", img: "../images/library.png", alt: "" }
                ]
            },
            {
                sentence: "S‚Äôil vous pla√Æt .",
                correct: "please",
                pictures: [
                    { id: "please", img: "../images/please.png", alt: "" },
                    { id: "collation", img: "../images/collation.png", alt: "" }
                ]
            }
        ];

         // --- CONFIG ---
    const QUESTIONS_PER_DAY = 12;
    const STORAGE_KEY = "FrenchPhrasesGame_progress";

    // --- Progress Tracking ---
    let correctCount = 0;
    let todayIndex = 0;
    let todayQuestions = [];
    let currentRound = 0;

    function getTodayKey() {
        const today = new Date().toISOString().slice(0, 10);
        return `${STORAGE_KEY}_${today}`;
    }

    function loadProgress() {
        const todayKey = getTodayKey();
        let idx = parseInt(localStorage.getItem(todayKey) || "0", 10);
        if (isNaN(idx) || idx < 0) idx = 0;
        todayIndex = idx;
    }

    function saveProgress() {
        const todayKey = getTodayKey();
        localStorage.setItem(todayKey, todayIndex.toString());
    }

    function getTodayRounds() {
        // Loop through rounds if needed
        let start = todayIndex;
        let result = [];
        for (let i = 0; i < QUESTIONS_PER_DAY; i++) {
            result.push(rounds[(start + i) % rounds.length]);
        }
        return result;
    }

    function advanceProgress() {
        todayIndex = (todayIndex + QUESTIONS_PER_DAY) % rounds.length;
        saveProgress();
    }

    function splitTextToSpans(text) {
        return text.split(/(\s+)/).map((word, i) => `<span data-word-idx="${i}">${word}</span>`).join("");
    }

    function highlightWordsByTimer(text, container, wordDuration = 700, onend) {
        let spans = Array.from(container.querySelectorAll('span[data-word-idx]'));
        let words = text.trim().split(/\s+/);
        let i = 0;
        function highlightNext() {
            spans.forEach(span => span.classList.remove('tts-highlight'));
            if (i < spans.length) {
                spans[i].classList.add('tts-highlight');
                i++;
                setTimeout(highlightNext, wordDuration);
            } else {
                spans.forEach(span => span.classList.remove('tts-highlight'));
                if (onend) onend();
            }
        }
        highlightNext();
    }

    function speakWithHighlight(text, lang, container, onend) {
        container.innerHTML = splitTextToSpans(text);

        // Use AndroidTTS if available
        if (typeof AndroidTTS !== 'undefined' && typeof AndroidTTS.speak === 'function') {
            highlightWordsByTimer(text, container, 700, onend);
            AndroidTTS.speak(text, lang);
            return;
        }

        // Web Speech API fallback
        if (!window.speechSynthesis) return;
        if (window.ttsUtterance) window.speechSynthesis.cancel();
        let spans = Array.from(container.querySelectorAll('span[data-word-idx]'));
        window.ttsUtterance = new SpeechSynthesisUtterance(text);

        // --- Try to select a French voice ---
        let voices = window.speechSynthesis.getVoices();
        let frenchVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('fr'));
        if (frenchVoice) {
            window.ttsUtterance.voice = frenchVoice;
            window.ttsUtterance.lang = frenchVoice.lang;
        } else {
            window.ttsUtterance.lang = "fr-FR";
        }

        window.ttsUtterance.rate = 0.4; // Slower for young learners
        let boundarySupported = false;
        window.ttsUtterance.onboundary = function(event) {
            boundarySupported = true;
            let charIndex = event.charIndex;
            let total = 0;
            for (let i = 0; i < spans.length; i++) {
                const len = spans[i].textContent.length;
                if (charIndex < total + len) {
                    spans.forEach(span => span.classList.remove('tts-highlight'));
                    spans[i].classList.add('tts-highlight');
                    break;
                }
                total += len;
            }
        };
        window.ttsUtterance.onstart = function() {
            spans.forEach(span => span.classList.remove('tts-highlight'));
            spans[0].classList.add('tts-highlight');
            setTimeout(() => {
                if (!boundarySupported) {
                    highlightWordsByTimer(text, container, 700, onend);
                }
            }, 200);
        };
        window.ttsUtterance.onend = function() {
            spans.forEach(span => span.classList.remove('tts-highlight'));
            if (onend) onend();
        };
        window.speechSynthesis.speak(window.ttsUtterance);
    }

    function updateStarCount() {
        document.getElementById("starCount").innerText = `‚≠ê ${correctCount} / ${QUESTIONS_PER_DAY}`;
    }

    function showRound() {
        const round = todayQuestions[currentRound];
        const sentenceDiv = document.getElementById("sentenceText");
        sentenceDiv.innerHTML = splitTextToSpans(round.sentence);
        document.getElementById("feedback").innerText = "";
        document.getElementById("playBtn").disabled = false;

        // Randomize correct/incorrect button position
        const pics = [...round.pictures];
        if (Math.random() < 0.5) {
            // correct on left
        } else {
            pics.reverse();
        }

        // Show picture buttons
        const btnsDiv = document.getElementById("pictureButtons");
        btnsDiv.innerHTML = "";
        pics.forEach(pic => {
            const btn = document.createElement("button");
            btn.className = "picture-btn";
            btn.innerHTML = `<img src="${pic.img}" alt="${pic.alt}"><br><span>${pic.alt}</span>`;
            btn.onclick = () => handleChoice(pic.id, btn);
            btnsDiv.appendChild(btn);
        });

        // Auto play sentence with highlight
        setTimeout(() => {
            speakWithHighlight(round.sentence, "fr-FR", sentenceDiv);
        }, 400);
    }

    function handleChoice(choiceId, btn) {
        const round = todayQuestions[currentRound];
        const feedbackDiv = document.getElementById("feedback");
        Array.from(document.getElementsByClassName("picture-btn")).forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        if (choiceId === round.correct) {
            feedbackDiv.innerHTML = "‚≠ê Correct!";
            correctCount++;
            updateStarCount();
            document.getElementById("playBtn").disabled = true;
            setTimeout(() => {
                currentRound++;
                if (currentRound < QUESTIONS_PER_DAY) {
                    showRound();
                } else {
                    feedbackDiv.innerHTML = "üéâ Game Over! Well done!";
                    document.getElementById("pictureButtons").innerHTML = "";
                    document.getElementById("playBtn").style.display = "none";
                    document.getElementById("sentenceText").innerHTML = "";
                    advanceProgress();
                    // Send game completed message to parent window/modal
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({ type: "gameCompleted" }, "*");
                    }
                }
            }, 1200);
        } else {
            feedbackDiv.innerHTML = "‚òπÔ∏è Try again!";
        }
    }

    document.getElementById("playBtn").onclick = function() {
        const round = todayQuestions[currentRound];
        speakWithHighlight(round.sentence, "fr-FR", document.getElementById("sentenceText"));
    };

    // --- Start game ---
    function startGame() {
        loadProgress();
        todayQuestions = getTodayRounds();
        correctCount = 0;
        currentRound = 0;
        updateStarCount();
        showRound();
    }

    document.addEventListener("DOMContentLoaded", startGame);

    </script>
</body>
</html>