<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Sentence Jumble</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="../commonCode.js"></script>
    <style>
        .game-container {
            width: 95%;
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            text-align: center;
        }
        .prompt-display {
            font-size: 22px;
            margin: 20px 0;
            color: #555;
        }
        .slot {
            background: #e0e0e0;
            border: 2px dashed #a0a0a0;
            border-radius: 10px;
            min-width: 80px;
            min-height: 45px;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #333;
        }
        .sentence-display {
            font-size: 24px;
            margin: 20px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 10px;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            min-height: 80px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        .word-btn {
            background: #ffc107;
            color: #333;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            user-select: none;
            font-size: 22px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .word-btn:hover {
            background: #ffca28;
            transform: translateY(-2px);
        }
        .word-btn.used {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .button-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        #messageContainer {
            font-size: 22px;
            font-weight: bold;
            min-height: 30px;
            margin-top: 15px;
        }
        .correct { color: #4CAF50; }
        .incorrect { color: #f44336; }
    </style>
</head>
<body>

    <div class="game-container">
        <h1>English Sentence Jumble</h1>
        <div id="starCount">‚≠ê 0 / 3</div>

        <div class="prompt-display" id="promptDisplay">Listen and build the sentence.</div>

        <div class="sentence-display" id="sentenceDisplay">
            <!-- User's constructed sentence will appear here -->
        </div>

        <div class="button-container">
            <button class="button" id="playSentenceBtn">Hear Sentence üîä</button>
        </div>

        <div id="messageContainer"></div>

        <div class="word-bank" id="wordBank"></div>

        <div class="button-container">
            <button id="deleteBtn" class="button" onclick="handleDelete()">‚å´ Delete</button>
            <button id="submitBtn" class="button green-button" onclick="handleSubmit()">Submit</button>
        </div>
    </div>

    <script>
        let gameData = [];
        let currentSentenceIndex = 0;
        let currentSentenceObj = {};
        let correctCount = 0;
        let maxQuestions = 3;
        let selectedWords = [];
        const STORAGE_KEY = 'englishSentenceJumble_currentIndex';

        document.addEventListener('DOMContentLoaded', loadGame);

        async function loadGame() {
            try {
                const response = await fetch('english-sentences.json');
                gameData = await response.json();
                maxQuestions = gameData.length;
                startGame();
            } catch (error) {
                console.error("Error loading sentence data:", error);
                document.querySelector('.game-container').innerHTML = '<h2>Could not load game data.</h2>';
            }
        }

        function startGame() {
            let savedIndex = parseInt(localStorage.getItem(STORAGE_KEY), 10);
            currentSentenceIndex = !isNaN(savedIndex) ? savedIndex : 0;
            correctCount = 0;
            updateStarCount();
            loadSentence();
        }

        function loadSentence() {
            if (currentSentenceIndex >= gameData.length) {
                currentSentenceIndex = 0; // Loop back
            }
            if (correctCount >= maxQuestions) {
                endGame();
                return;
            }

            currentSentenceObj = gameData[currentSentenceIndex];
            selectedWords = [];

            document.getElementById('messageContainer').innerHTML = '';
            document.getElementById('playSentenceBtn').onclick = () => readText(currentSentenceObj.sentence, 'en-US');

            updateSentenceDisplay();
            createWordBank();

            setTimeout(() => readText(`Make the sentence: ${currentSentenceObj.sentence}`, 'en-US'), 500);
        } 

        function createWordBank() {
            const wordBank = document.getElementById('wordBank');
            wordBank.innerHTML = '';

            const allWords = [...currentSentenceObj.correctWords, ...currentSentenceObj.extraWords];
            const shuffledWords = allWords.sort(() => Math.random() - 0.5);

            shuffledWords.forEach(word => {
                const wordBtn = document.createElement('button');
                wordBtn.className = 'word-btn';
                wordBtn.textContent = word;
                wordBtn.dataset.word = word;
                wordBtn.onclick = handleWordClick;
                wordBank.appendChild(wordBtn);
            });
        }

        function handleWordClick(event) {
            const btn = event.target;
            if (btn.classList.contains('used')) return;

            selectedWords.push(btn.dataset.word);
            btn.classList.add('used');
            readText(btn.dataset.word, 'en-US'); // Say the word when clicked
            updateSentenceDisplay();
        }

        function handleDelete() {
            if (selectedWords.length > 0) {
                const lastWord = selectedWords.pop();
                const wordButtons = document.querySelectorAll('.word-btn.used');
                // Find the last button that matches the word to re-enable it
                for (let i = wordButtons.length - 1; i >= 0; i--) {
                    if (wordButtons[i].dataset.word === lastWord) {
                        wordButtons[i].classList.remove('used');
                        break;
                    }
                }
                updateSentenceDisplay();
            }
        }

        function updateSentenceDisplay() {
            const display = document.getElementById('sentenceDisplay');
            display.innerHTML = ''; // Clear previous content

            // Create slots for each word
            currentSentenceObj.correctWords.forEach((word, index) => {
                const slot = document.createElement('div');
                slot.className = 'slot';
                if (selectedWords[index]) {
                    slot.textContent = selectedWords[index];
                    slot.style.borderStyle = 'solid';
                    slot.style.background = '#e9f5ff';
                }
                display.appendChild(slot);
            });

            // Add punctuation at the end
            const fullSentence = currentSentenceObj.sentence;
            const punctuation = fullSentence.slice(-1);
            const punctuationEl = document.createElement('span');
            punctuationEl.textContent = punctuation;
            punctuationEl.style.fontSize = '24px';
            display.appendChild(punctuationEl);
        }

        function handleSubmit() {
            const messageContainer = document.getElementById('messageContainer');
            const isCorrect = JSON.stringify(selectedWords) === JSON.stringify(currentSentenceObj.correctWords);

            if (isCorrect) {
                messageContainer.textContent = 'Correct! üéâ';
                messageContainer.className = 'correct';
                correctCount++;
                updateStarCount();
                readText("Awesome!", 'en-US');
                setTimeout(nextSentence, 2000);
            } else {
                messageContainer.textContent = 'Not quite, try again!';
                messageContainer.className = 'incorrect';
                readText("Oops, try that again.", 'en-US', () => {
                    setTimeout(() => { messageContainer.textContent = ''; }, 1500);
                });
                // Reset for another try
                selectedWords = [];
                updateSentenceDisplay();
                document.querySelectorAll('.word-btn.used').forEach(btn => btn.classList.remove('used'));
            }
        }

        function nextSentence() {
            currentSentenceIndex++;
            if (currentSentenceIndex >= gameData.length) currentSentenceIndex = 0; // Loop
            localStorage.setItem(STORAGE_KEY, currentSentenceIndex.toString());
            loadSentence();
        }

        function updateStarCount() {
            document.getElementById('starCount').innerText = `‚≠ê ${correctCount} / ${maxQuestions}`;
        }

        function endGame() {
            document.querySelector('.game-container').innerHTML = `
                <h1>Game Complete!</h1>
                <h2>Final Score: ${correctCount} / ${maxQuestions} ‚≠ê</h2>
            `;
            if (window.parent) {
                window.parent.postMessage({ type: 'gameCompleted' }, '*');
            }
        }
    </script>
</body>
</html>